function getRatingKey(e){return"rating-"+e}function hasRated(e){return!!localStorage.getItem(getRatingKey(e))}function getRatedValue(e){return parseInt(localStorage.getItem(getRatingKey(e))||"0")}function storeRating(e,t){localStorage.setItem(getRatingKey(e),t)}function clearHover(e){e.querySelectorAll(".star").forEach(e=>e.classList.remove("hover"))}function updatePreview(e,t){let a=Math.floor(t);e.querySelectorAll(".star").forEach(e=>{var t=parseInt(e.dataset.value);e.classList.toggle("preview",t<=a)})}function setupHoverEffect(t){let n=t.querySelectorAll(".star");n.length&&n.forEach(e=>{let a=parseInt(e.dataset.value);e.addEventListener("mouseenter",()=>{n.forEach(e=>{e.classList.remove("preview");var t=parseInt(e.dataset.value);e.classList.toggle("hover",t<=a)})}),e.addEventListener("mouseleave",()=>{clearHover(t);var e=parseFloat(t.querySelector(".avg")?.textContent.replace(/[()]/g,"")||"0");updatePreview(t,e)})})}function calculateAverage(e={}){var e=Object.entries(e).filter(([e])=>!isNaN(Number(e))),t=e.reduce((e,[t,a])=>e+Number(t)*a,0),e=e.reduce((e,[,t])=>e+t,0);return 0<e?(t/e).toFixed(1):"0.0"}async function loadRating(a){var n=a.dataset.id,r=a.dataset.api;if(n&&r)try{var i=(await(await fetch(r+"/info?id="+encodeURIComponent(n))).json()).rating||{},o=calculateAverage(i),c=Object.entries(i).filter(([e])=>!isNaN(Number(e))).reduce((e,[,t])=>e+t,0);let e=a.querySelector(".avg"),t=(e||((e=document.createElement("span")).className="avg",a.appendChild(e)),e.textContent=`(${o})`,a.querySelector(".count"));t||((t=document.createElement("span")).className="count",a.appendChild(t)),t.textContent=""+c,updatePreview(a,o)}catch(e){console.warn("[rating] 加载失败: id="+n,e)}}async function submitRating(e,t){var a=e.dataset.id,n=e.dataset.api;if(a&&n&&!hasRated(a)){storeRating(a,t),e.classList.add("rated");try{await fetch(`${n}/update?id=${encodeURIComponent(a)}&value=`+t,{method:"POST"}),loadRating(e)}catch(e){console.warn("[rating] 提交失败: id="+a,e)}}}function initRatings(){document.querySelectorAll(".ds-rating").forEach(a=>{let{id:n,api:e}=a.dataset;n&&e&&(loadRating(a),setupHoverEffect(a),hasRated(n)&&a.classList.add("rated"),a.querySelectorAll(".star").forEach(e=>{let t=e.dataset.value;e.addEventListener("click",()=>{hasRated(n)||submitRating(a,t)})}))})}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",initRatings):initRatings();