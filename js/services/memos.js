utils.jq(()=>{Array.from(document.getElementsByClassName("ds-memos")).forEach(i=>{let a=i.dataset.api;if(!a)return;let r=i.getAttribute("avatar")||def.avatar,n=i.getAttribute("limit"),l=a.match(/https:\/\/(.*?)\/(.*)/i)[1];utils.request(i,a,async e=>{e=await e.json();let t=d.identify(e);if("feature"!==t.version){let s=i.getAttribute("user")?.split(",")||[],a=i.getAttribute("hide")?.split(",")||[];await Promise.all(t.data.slice(0,n||t.data.length).map(e=>(async(e,s,a,t,i,r)=>{var n=d[s.version]||d.feature;return`<div class="timenode">
                      <div class="header">${a.length||t.includes("user")?"":await n.buildUser(e,s,i)}
                      <span>${n.buildDate(e).toLocaleString()}</span></div>
                      <div class="body">${marked.parse(e.content||"")}
                      <div class="tag-plugin image">${n.buildImages(e,r).join("")}</div>
                      </div></div>`})(e,t,s,a,r,l).then(e=>$(i).append(e))))}});let d={"22-":{buildUser:async(e,s,a)=>`<div class="user-info">${a?`<img src="${a}">`:""}<span>${e.creatorName}</span></div>`,buildDate:e=>new Date(1e3*e.createdTs),buildImages:(e,s)=>(e.resourceList||[]).filter(e=>e.type?.includes("image/")).map(e=>`<div class="image-bg"><img src="${e.externalLink||`https://${s}/o/r/`+e.id}"></div>`)},"22+":{buildUser:async(e,s,a)=>{let t=e?.creator.split("/")[1],i=s.users.find(e=>e.id===parseInt(t));i||(s.requests[t]||(s.requests[t]=fetch(s.site+"/api/v1/users/"+t).then(e=>e.json()).then(e=>{e.username?(i=e,s.users.push(e)):i=null}).finally(()=>delete s.requests[t])),await s.requests[t],i=s.users.find(e=>e.id===parseInt(t)));e=i?i.nickname||i.username:"memos",a=i?.avatarUrl?""+s.site+i.avatarUrl:a||"";return`<div class="user-info">${a?`<img src="${a}">`:""}<span>${e}</span></div>`},buildDate:e=>new Date(e.createTime),buildImages:e=>(e.resources||[]).filter(e=>e.type?.includes("image/")).map(e=>`<div class="image-bg"><img src="${e.externalLink||`https://${l}/o/r/`+e.id}"></div>`)},feature:{buildUser:async()=>"memos",buildDate:()=>new Date,buildImages:()=>[]},identify:e=>{var s={version:"feature",users:[],site:a.split("/api/v1")[0],requests:{},data:[]};return Array.isArray(e)?(s.version="22-",s.data=e):e.memos?(s.version="22+",s.data=e.memos):(s.version="feature",console.log("当前Memos版本过高，请到Stellar社区反馈")),s}}})});