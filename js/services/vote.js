function getVoteKey(e){return"vote-"+e}function hasVoted(e){return!!localStorage.getItem(getVoteKey(e))}function getVotedValue(e){return localStorage.getItem(getVoteKey(e))}function storeVote(e,t){localStorage.setItem(getVoteKey(e),t)}function removeVote(e){localStorage.removeItem(getVoteKey(e))}function markVoted(e,t){e.classList.add("voted"),"up"===t?e.querySelector(".vote-up")?.classList.add("active"):"down"===t&&e.querySelector(".vote-down")?.classList.add("active")}function revertVote(e,t){var o,n=e.dataset.id;"up"===t?(o=e.querySelector(".up"))&&(o.textContent=Math.max(0,parseInt(o.textContent||"1")-1)):"down"===t&&(o=e.querySelector(".down"))&&(o.textContent=Math.max(0,parseInt(o.textContent||"1")-1)),e.classList.remove("voted","active"),e.querySelector(".vote-up")?.classList.remove("active"),e.querySelector(".vote-down")?.classList.remove("active"),removeVote(n)}async function loadVote(e){var t=e.dataset.id,o=e.dataset.api;if(t&&o)try{var n=await(await fetch(o+"/info?id="+encodeURIComponent(t))).json();e.querySelector(".up").textContent=n.votes?.up??0,e.querySelector(".down").textContent=n.votes?.down??0}catch(e){console.warn("[vote] 加载失败: id="+t,e)}}function submitVote(t,o){let n=t.dataset.id;var e,a,r=t.dataset.api;n&&r&&!hasVoted(n)&&(e=t.querySelector(".up"),a=t.querySelector(".down"),"up"===o&&e&&(e.textContent=parseInt(e.textContent||"0")+1),"down"===o&&a&&(a.textContent=parseInt(a.textContent||"0")+1),storeVote(n,o),markVoted(t,o),fetch(`${r}/update?id=${encodeURIComponent(n)}&value=`+encodeURIComponent(o),{method:"POST"}).catch(e=>{console.warn("[vote] 后台同步失败，撤销投票: id="+n,e),revertVote(t,o)}))}function initVotes(){document.querySelectorAll(".ds-vote").forEach(e=>{var{id:t,api:o}=e.dataset;t&&o&&(loadVote(e),(o=getVotedValue(t))&&markVoted(e,o),e.querySelector(".vote-up")?.addEventListener("click",()=>{e.classList.contains("active")||submitVote(e,"up")}),e.querySelector(".vote-down")?.addEventListener("click",()=>{e.classList.contains("active")||submitVote(e,"down")}))})}"loading"===document.readyState?window.addEventListener("DOMContentLoaded",initVotes):initVotes();