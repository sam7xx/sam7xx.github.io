<%
function layoutDiv() {
  var el = ''
  el += `<nav class="menu dis-select${where == 'main' ? ' mobile-hidden' : ''}">`
  
  // 分离普通菜单项和"更多"菜单项
  const moreItem = (theme.menubar.items || []).find(item => item?.id === 'more');
  const regularItems = (theme.menubar.items || []).filter(item => 
    item && item.id != null && item.url != null && item.id !== 'more'
  );
  
  // 渲染普通菜单项
  for (let item of regularItems) {
    el += `<a class="nav-item${item.id == page.menu_id ? ' active' : ''}" title="${item.title}" href="${pretty_url(item.url)}"`
    if (item.theme?.length > 0) {
      el += ` style="color:${item.theme}"`
    }
    el += `>`
    if (item.icon?.length > 0) {
      el += icon(item.icon, 'no-lazy')
    } else {
      el += `<span>${__(item.title)}</span>`
    }
    el += `</a>`
  }
  
  // 渲染"更多"菜单项及下拉菜单
  if (moreItem) {
    // 检查是否有子菜单配置
    const hasSubmenu = moreItem.nested && moreItem.nested.length > 0;
    
    el += `<div class="nav-item more-dropdown${moreItem.id == page.menu_id ? ' active' : ''}"`;
    if (moreItem.theme?.length > 0) {
      el += ` style="color:${moreItem.theme}"`;
    }
    el += `>`;
    
    // 更多按钮
    el += `<a class="more-toggle" title="${moreItem.title}"`;
    if (!hasSubmenu) {
      el += ` href="${pretty_url(moreItem.url)}"`;
    }
    el += `>`;
    if (moreItem.icon?.length > 0) {
      el += icon(moreItem.icon, 'no-lazy');
    } else {
      el += `<span>${__(moreItem.title)}</span>`;
    }
    el += `</a>`;
    
    // 下拉菜单
    if (hasSubmenu) {
      el += `<div class="more-dropdown-menu">`;
      for (let subItem of moreItem.nested) {
        if (subItem && subItem.title && subItem.url) {
          el += `<a class="dropdown-item" href="${pretty_url(subItem.url)}" title="${subItem.title}">`;
          el += `<span>${__(subItem.title)}</span>`;
          el += `</a>`;
        }
      }
      el += `</div>`;
    }
    
    el += `</div>`;
  }
  
  el += `</nav>`
  return el
}
%>

<%- layoutDiv() %>